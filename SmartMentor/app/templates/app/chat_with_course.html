{% extends 'app/chatbot_base.html' %}

{% block styles %}
<style>
    body, html {
      height: 100%;
      margin: 0;
      display: flex;
      overflow: hidden; /* Prevents the entire page from scrolling */
    }

    .chat-container {
      height: 100%;
      display: flex;
      flex-direction: column;
      width: 70%; /* Adjust width as needed */
      border-right: 2px solid #ddd; /* Add a border for separation */
      overflow-y: auto; /* Allows chat container to scroll */
    }

    .card {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .messages-box {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      background-color: #f0f0f0; /* Light background for messages area */
    }

    .messages-list {
      padding-left: 0;
    }

    .message {
      margin-bottom: 15px;
      list-style: none;
    }

    .message-text {
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1); /* Add a shadow for depth */
    }

    .sent {
      background-color: #d1e7dd; /* Light green for sent messages */
      align-self: flex-end;
      color: #0f5132; /* Dark green text */
    }

    .received {
      background-color: #f8d7da; /* Light red for received messages */
      align-self: flex-start;
      color: #842029; /* Dark red text */
    }

    .message-form {
      display: flex;
      padding: 10px;
      background-color: #fff;
      border-top: 1px solid #ddd;
    }

    .message-input {
      flex: 1;
      border-radius: 5px 0 0 5px;
      border: 1px solid #ddd;
      padding: 10px;
    }

    .btn-send {
      border-radius: 0 5px 5px 0;
      border: 1px solid #ddd;
      background-color: #0d6efd; /* Primary button color */
      color: white;
    }

    .image-container {
      width: 30%;
      padding: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #e9ecef; /* Light grey background for image container */
      position: fixed;
      right: 0;
      top: 0;
      bottom: 0;
    }

    .image-container img {
      max-width: 100%;
      max-height: 100%;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Add shadow for depth */
    }

    .card-header {
      background-color: #0d6efd; /* Primary header color */
      color: white;
    }

  </style>
{% endblock %}


{% block content %}
<div class="image-container">
    {% load static %}
    <img src="{% static 'images/course_image_chat.jpg' %}" alt="Course Image">
</div>
<div class="chat-container">
  <div class="card flex-grow-1">
    <div class="card-header text-white">
      <div class="row">
        <div class="col-md-6">Course: {{ course.name }}</div>
        <div class="col-md-6 text-right">Welcome, {{ user.profile.username }}</div>
      </div>
    </div>
    <div class="card-body messages-box">
      <ul class="list-unstyled messages-list">
        <li class="message received">
          <div class="message-text">
            <div class="message-sender">
              <b>{{ course.name }}</b>
            </div>
            <div class="message-content">
              Hello! I am your digital assistant for the {{ course.name }} course. I'm here to help you navigate through the material and answer any questions you might have. To begin the course, simply click the "Start" button. You can move through the different sections using the "Next" and "Prev" buttons. If you ever find yourself confused or need further clarification, don't hesitate to ask a question. Let's make learning enjoyable and productive. Have fun!
            </div>
          </div>
        </li>
      </ul>
    </div>
  </div>
  <div class="input-group-append" style="margin-left: 20px;">
    <button id="startBtn" class="btn btn-warning" style="margin-right: 10px;">Start</button>
    <button id="nextBtn" class="btn btn-warning" style="margin-right: 10px; display: none;">Next</button>
    <button id="prevBtn" class="btn btn-warning" style="display: none;">Prev</button>
  </div>
  <form class="message-form">
    {% csrf_token %}
    <div class="input-group">
      <input type="text" class="form-control message-input" placeholder="Type your message...">
      <div class="input-group-append">
        <button type="submit" class="btn btn-primary btn-send">Send</button>
      </div>
    </div>
  </form>
</div>

<script>
    const messagesList = document.querySelector('.messages-list');
    const messageForm = document.querySelector('.message-form');
    const messageInput = document.querySelector('.message-input');

    const startBtn = document.getElementById('startBtn');
    const nextBtn = document.getElementById('nextBtn');
    const prevBtn = document.getElementById('prevBtn');

    messageForm.addEventListener('submit', (event) => {
        event.preventDefault();

        const message = messageInput.value.trim();
        if(message.length === 0) {
            return;
        }

        const messageItem = document.createElement('li');
        messageItem.classList.add('message', 'sent');
        messageItem.innerHTML = `
            <div class="message-text">
                <div class="message-sender">
                  <b>${'{{ user.profile.username }}'}</b>
                </div>
                <div class="message-content">
                    ${message}
                </div>
            </div>`;
        messagesList.appendChild(messageItem);

        messageInput.value = '';

        fetch('',{
            method : 'POST',
            headers : {
                'Content-Type' : 'application/x-www-form-urlencoded'
            },
            body : new URLSearchParams({
                'csrfmiddlewaretoken' : document.querySelector('input[name="csrfmiddlewaretoken"]').value,
                'message' : message
            })
        })
        .then(response => response.json())
        .then(data => {
            const response = data.response;
            const messageItem = document.createElement('li');
            messageItem.classList.add('message', 'received');
            messageItem.innerHTML = `
                <div class="message-text">
                    <div class="message-sender">
                        <b>{{ course.name }}</b>
                    </div>
                    <div class="message-content">
                        ${response}
                    </div>
                </div>`;

            messagesList.appendChild(messageItem);
        });
    });


    startBtn.addEventListener('click', () => {
      messageInput.value = 'start';
      messageForm.dispatchEvent(new Event('submit'))
      document.getElementById('nextBtn').style.display = 'inline-block';
      document.getElementById('prevBtn').style.display = 'inline-block';
      document.getElementById('startBtn').style.display = 'none';  // Hide the "Start" button
  });

  nextBtn.addEventListener('click', () => {
      messageInput.value = 'next';
      messageForm.dispatchEvent(new Event('submit'));
  });

  prevBtn.addEventListener('click', () => {
      messageInput.value = 'prev';
      messageForm.dispatchEvent(new Event('submit'));
  });

</script>

{% endblock %}
